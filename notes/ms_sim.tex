\documentclass[10pt,fleqn]{article}
% \usepackage[journal=rsc]{chemstyle}
% \usepackage{mhchem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{esint}
\usepackage{bbm}
\usepackage{amscd}
\usepackage{picinpar}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{tikz-3dplot}
\usepackage{indentfirst}
\usepackage{wrapfig}
\usepackage{units}
\usepackage{textcomp}
\usepackage[utf8x]{inputenc}
% \usepackage{feyn}
\usepackage{feynmp}
\usepackage{xkeyval}
\usepackage{xargs}
\usepackage{verbatim}
\usepackage{pgfplots}
\usepackage{hyperref}
\usetikzlibrary{
  arrows,
  calc,
  decorations.pathmorphing,
  decorations.pathreplacing,
  decorations.markings,
  fadings,
  positioning,
  shapes
}

\DeclareGraphicsRule{*}{mps}{*}{}
\newcommand{\ud}{\mathrm{d}}
\newcommand{\ue}{\mathrm{e}}
\newcommand{\ui}{\mathrm{i}}
\newcommand{\res}{\mathrm{Res}}
\newcommand{\Tr}{\mathrm{Tr}}
\newcommand{\dsum}{\displaystyle\sum}
\newcommand{\dprod}{\displaystyle\prod}
\newcommand{\dlim}{\displaystyle\lim}
\newcommand{\dint}{\displaystyle\int}
\newcommand{\fsno}[1]{{\!\not\!{#1}}}
\newcommand{\eqar}[1]
{
  \begin{align*}
    #1
  \end{align*}
}
\newcommand{\texp}[2]{\ensuremath{{#1}\times10^{#2}}}
\newcommand{\dexp}[2]{\ensuremath{{#1}\cdot10^{#2}}}
\newcommand{\eval}[2]{{\left.{#1}\right|_{#2}}}
\newcommand{\paren}[1]{{\left({#1}\right)}}
\newcommand{\lparen}[1]{{\left({#1}\right.}}
\newcommand{\rparen}[1]{{\left.{#1}\right)}}
\newcommand{\abs}[1]{{\left|{#1}\right|}}
\newcommand{\sqr}[1]{{\left[{#1}\right]}}
\newcommand{\crly}[1]{{\left\{{#1}\right\}}}
\newcommand{\angl}[1]{{\left\langle{#1}\right\rangle}}
\newcommand{\tpdiff}[4][{}]{{\paren{\frac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}_{#4}}}
\newcommand{\tpsdiff}[4][{}]{{\paren{\frac{\partial^{#1}}{\partial {#3}{}^{#1}}{#2}}_{#4}}}
\newcommand{\pdiff}[3][{}]{{\frac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}}
\newcommand{\diff}[3][{}]{{\frac{\ud^{#1} {#2}}{\ud {#3}{}^{#1}}}}
\newcommand{\psdiff}[3][{}]{{\frac{\partial^{#1}}{\partial {#3}{}^{#1}} {#2}}}
\newcommand{\sdiff}[3][{}]{{\frac{\ud^{#1}}{\ud {#3}{}^{#1}} {#2}}}
\newcommand{\tpddiff}[4][{}]{{\left(\dfrac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}\right)_{#4}}}
\newcommand{\tpsddiff}[4][{}]{{\paren{\dfrac{\partial^{#1}}{\partial {#3}{}^{#1}}{#2}}_{#4}}}
\newcommand{\pddiff}[3][{}]{{\dfrac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}}
\newcommand{\ddiff}[3][{}]{{\dfrac{\ud^{#1} {#2}}{\ud {#3}{}^{#1}}}}
\newcommand{\psddiff}[3][{}]{{\frac{\partial^{#1}}{\partial{}^{#1} {#3}} {#2}}}
\newcommand{\sddiff}[3][{}]{{\frac{\ud^{#1}}{\ud {#3}{}^{#1}} {#2}}}
\usepackage{fancyhdr}
\usepackage{multirow}
\usepackage{fontenc}
% \usepackage{tipa}
\usepackage{ulem}
\usepackage{color}
\usepackage{cancel}
\newcommand{\hcancel}[2][black]{\setbox0=\hbox{#2}%
  \rlap{\raisebox{.45\ht0}{\textcolor{#1}{\rule{\wd0}{1pt}}}}#2}
\pagestyle{fancy}
\setlength{\headheight}{67pt}
\fancyhead{}
\fancyfoot{}
\fancyfoot[C]{\thepage}
\fancyhead[R]{}
\renewcommand{\footruleskip}{0pt}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

\newcommand\pgfmathsinandcos[3]{%
  \pgfmathsetmacro#1{sin(#3)}%
  \pgfmathsetmacro#2{cos(#3)}%
}
\newcommand\LongitudePlane[3][current plane]{%
  \pgfmathsinandcos\sinEl\cosEl{#2} % elevation
  \pgfmathsinandcos\sint\cost{#3} % azimuth
  \tikzset{#1/.estyle={cm={\cost,\sint*\sinEl,0,\cosEl,(0,0)}}}
}
\newcommand\LatitudePlane[3][current plane]{%
  \pgfmathsinandcos\sinEl\cosEl{#2} % elevation
  \pgfmathsinandcos\sint\cost{#3} % latitude
  \pgfmathsetmacro\yshift{\cosEl*\sint}
  \tikzset{#1/.estyle={cm={\cost,0,0,\cost*\sinEl,(0,\yshift)}}} %
}
\newcommand\DrawLongitudeCircle[2][1]{
  \LongitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{atan(sin(#2)*cos(\angEl)/sin(\angEl))} %
  \draw[current plane] (\angVis:1) arc (\angVis:\angVis+180:1);
  \draw[current plane,dashed] (\angVis-180:1) arc (\angVis-180:\angVis:1);
}
\newcommand\DrawLatitudeCircleArrow[2][1]{
  \LatitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  \pgfmathsetmacro\sinVis{sin(#2)/cos(#2)*sin(\angEl)/cos(\angEl)}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{asin(min(1,max(\sinVis,-1)))}
  \draw[current plane,decoration={markings, mark=at position 0.6 with {\arrow{<}}},postaction={decorate},line width=.6mm] (\angVis:1) arc (\angVis:-\angVis-180:1);
  \draw[current plane,dashed,line width=.6mm] (180-\angVis:1) arc (180-\angVis:\angVis:1);
}
\newcommand\DrawLatitudeCircle[2][1]{
  \LatitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  \pgfmathsetmacro\sinVis{sin(#2)/cos(#2)*sin(\angEl)/cos(\angEl)}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{asin(min(1,max(\sinVis,-1)))}
  \draw[current plane] (\angVis:1) arc (\angVis:-\angVis-180:1);
  \draw[current plane,dashed] (180-\angVis:1) arc (180-\angVis:\angVis:1);
}
\newcommand\coil[1]{
  {\rh * cos(\t * pi r)}, {\apart * (2 * #1 + \t) + \rv * sin(\t * pi r)}
}
\makeatletter
\define@key{DrawFromCenter}{style}[{->}]{
  \tikzset{DrawFromCenterPlane/.style={#1}}
}
\define@key{DrawFromCenter}{r}[1]{
  \def\@R{#1}
}
\define@key{DrawFromCenter}{center}[(0, 0)]{
  \def\@Center{#1}
}
\define@key{DrawFromCenter}{theta}[0]{
  \def\@Theta{#1}
}
\define@key{DrawFromCenter}{phi}[0]{
  \def\@Phi{#1}
}
\presetkeys{DrawFromCenter}{style, r, center, theta, phi}{}
\newcommand*\DrawFromCenter[1][]{
  \setkeys{DrawFromCenter}{#1}{
    \pgfmathsinandcos\sint\cost{\@Theta}
    \pgfmathsinandcos\sinp\cosp{\@Phi}
    \pgfmathsinandcos\sinA\cosA{\angEl}
    \pgfmathsetmacro\DX{\@R*\cost*\cosp}
    \pgfmathsetmacro\DY{\@R*(\cost*\sinp*\sinA+\sint*\cosA)}
    \draw[DrawFromCenterPlane] \@Center -- ++(\DX, \DY);
  }
}
\newcommand*\DrawFromCenterText[2][]{
  \setkeys{DrawFromCenter}{#1}{
    \pgfmathsinandcos\sint\cost{\@Theta}
    \pgfmathsinandcos\sinp\cosp{\@Phi}
    \pgfmathsinandcos\sinA\cosA{\angEl}
    \pgfmathsetmacro\DX{\@R*\cost*\cosp}
    \pgfmathsetmacro\DY{\@R*(\cost*\sinp*\sinA+\sint*\cosA)}
    \draw[DrawFromCenterPlane] \@Center -- ++(\DX, \DY) node {#2};
  }
}
\makeatother
\tikzstyle{snakearrow} = [decorate, decoration={pre length=0.2cm,
  post length=0.2cm, snake, amplitude=.4mm,
  segment length=2mm},thick, ->]
%% document-wide tikz options and styles
\tikzset{%
  >=latex, % option for nice arrows
  inner sep=0pt,%
  outer sep=2pt,%
  mark coordinate/.style={inner sep=0pt,outer sep=0pt,minimum size=3pt,
    fill=black,circle}%
}
\addtolength{\hoffset}{-1.3cm}
\addtolength{\voffset}{-2cm}
\addtolength{\textwidth}{3cm}
\addtolength{\textheight}{2.5cm}
\renewcommand{\footskip}{10pt}
\setlength{\headwidth}{\textwidth}
\setlength{\headsep}{20pt}
\setlength{\marginparwidth}{0pt}
\parindent=0pt
\title{M{\o}lmer-S{\o}rensen gate simulation}

\ifpdf
  % Ensure reproducible output
  \pdfinfoomitdate=1
  \pdfsuppressptexinfo=-1
  \pdftrailerid{}
  \hypersetup{
    pdfcreator={},
    pdfproducer={}
  }
\fi

\begin{document}

\maketitle

\section{Goal}
Derive the expression for simulating and optimizing a M{\o}lmer-S{\o}rensen gate
pulse sequence.\\

\section{Setup and scope}
We'll discuss a simple two tone pulse sequence where the two tones
are perfectly symmetric around the carrier.
We'll ignore any error in the carrier frequency in this note.
Crosstalk, coupling to carrier and other sideband orders are also ignored.\\

For a typical gate sequence, what we care about are
\begin{enumerate}
\item Ion motion:\\
  The MS interaction will drive each of the motional mode in a spin-dependent way.
  For a proper MS gate, we'd like the final motional state to be identical
  to where we started. Any deviation from this results in a closure error.
\item Spin operation:\\
  The enclosed area in phase-space from the driven motion results in
  a spin-dependent phase which is the main goal of the MS gate.
  Deviation in the control parameter could result in spin/angle error
  in the spin space.
\end{enumerate}

\section{M{\o}lmer-S{\o}rensen interaction}
The effective Hamiltonian for a M{\o}lmer-S{\o}rensen gate sequence can be written as
\eqar{
  H_{MS}=&\frac{\Omega(t)}{2}\sum_{j=1,2}\sum_{k}\eta_{jk}\paren{a_k\ue^{-\ui\theta_k(t)}+a_k^\dagger\ue^{\ui\theta_k(t)}}\sigma^j_x
}
where $j$ is the ion index (simplified to $1$ and $2$)
and $k$ is the motional mode index.
For the ``fixed'' parameters, $\eta_{jk}$ is the Lamb-Dicke parameter for the $j$-th
ion on the $k$-th mode. $a_k$ and $a^\dagger_k$ are the creation and annihilation
operators for the $k$-th mode and the $\sigma_x^j$ is the single qubit spin operator
we are coupling to which we'll set as $x$ in this note.
(The error on the spin axis is ignored.)
For the ``variable'' parameters in the pulse sequence,
$\Omega(t)$ is the time dependent two-photon Rabi frequency (controlled by laser power)
and $\theta_k(t)$ is the time-dependent phase offset between the laser and the $k$-th
mode with,
\eqar{
  \theta_k(t)=&\omega_kt-\theta(t)\\
  =&\omega_kt-\int_0^t\delta(t')\ud t'
}
where $\omega_k$ is the frequency of the $k$-th mode,
$\theta(t)$ is the half the phase difference of the two lasers
and $\delta(t')$ is the (symmetric) detuning of the lasers from the carrier.
(If phase modulation is used, $\theta(t)$ and $\theta_k(t)$
may be discontinuous functions).\\

Using Magnus expansion, we can write down the unitary evalution of the system as
\eqar{
  U_{MS}(\tau)=&\exp\sqr{\sum_{j=1,2}\sum_{k}\frac{\eta_{kj}}{2}\paren{\alpha_k(\tau)a^\dagger_k-\alpha^*_k(\tau)a_k}\sigma^j_x}\exp\paren{\ui\Theta(\tau)\sigma^1_x\sigma^2_x}
}
where
\eqar{
  \alpha_k(\tau)=&\int_0^\tau\Omega(t)\ue^{\ui\theta_k(t)}\ud t
}
describes the displacement of the $k$-th mode, and
\eqar{
  \Theta(\tau)=&\frac{1}{2}\sum_k\eta_{k1}\eta_{k2}\int_0^\tau\!\!\ud t\int_0^t\!\!\ud t'
  \ \Omega(t)\Omega(t')\sin(\theta_k(t)-\theta_k(t'))
}
is the angle of the two-qubit rotation. For a proper MS gate of length $T$,
we need to have $\alpha_k(T)=0$ for all $k$s and the rotation angle
at the end of the pulse $\Theta(T)$ matching the angle we want.\\

For the purpose of optimization, the quantities we care about are.
\begin{enumerate}
\item Closure
  \eqar{
    \alpha_k(T)=&\int_0^T\Omega(t)\ue^{\ui\theta_k(t)}\ud t
  }
\item Enclosed area
  \eqar{
    \mathcal{A}_k=&\mathrm{Im}\paren{\int_0^T\!\!\ud t\int_0^t\!\!\ud t'
      \ \Omega(t)\Omega(t')\ue^{\ui\theta_k(t)-\ui\theta_k(t')}}\\
    =&\mathrm{Im}\paren{\int_0^T\!\!\ud t\ \Omega(t)\ue^{\ui\theta_k(t)}\int_0^t\!\!\ud t'
      \ \Omega(t')\ue^{-\ui\theta_k(t')}}
  }
\end{enumerate}
And the gradient of these w.r.t. to the mode frequencies and pulse control parameters.\\

One special case of these gradients is the gradient of displacement
w.r.t. mode frequencies,
\eqar{
  \pdiff{\alpha_k(T)}{\omega_k}=&\int_0^T\frac{\partial}{\partial\omega_k}\Omega(t)\ue^{\ui\theta_k(t)}\ud t\\
  =&\ui\int_0^T\Omega(t)\ue^{\ui\theta_k(t)}\frac{\partial\theta_k(t)}{\partial\omega_k}\ud t\\
  =&\ui\int_0^T\Omega(t)\ue^{\ui\theta_k(t)}t\ud t
}
When closure is assumed, this can be re-written as,
\eqar{
  \pdiff{\alpha_k(T)}{\omega_k}=&\ui\int_0^T\Omega(t)\ue^{\ui\theta_k(t)}t\ud t\\
  =&\ui\left.t\int_0^t\Omega(t')\ue^{\ui\theta_k(t')}\ud t'\right|_0^T-\ui\int_0^T\ud t\int_0^t\Omega(t')\ue^{\ui\theta_k(t')}\ud t'\\
  =&-\ui\int_0^T\ud t\int_0^t\Omega(t')\ue^{\ui\theta_k(t')}\ud t'
}
which is proportional to average displacement.
Moreover, if the pulse is symmetric, zeroing this value will also automatically
zero the final displacement thus remove the need to optimize
two values at the same time.

For all other derivatives, (including the derivative of the average displacement
w.r.t. pulse parameters) we'll compute directly on the result of the integral.

\section{Segmented pulse}
When parameterizing the pulse shape used to drive MS gate,
the pulse is usually decomposed into a few segments (in time)
and the pulse shape within each segment is only sensitive to
few parameters. We can take advantage of this structure
to reduce the computational complexity when optimizing for
a large number of free parameters by only dealing with one segment
(and therefore few parameters) at a time.\\

More specifically, during the optimization process,
we care about the gradient of the values listed above (closure, area, etc.)
w.r.t. the pulse shape parameters.
By dealing with the effect of each segment properly,
we can compute all the gradient within $\mathcal{O}(N_p + N_s)$
instead of $\mathcal{O}(N_pN_s)$, where $N_p$ is the number of parameters
and $N_s$ is the number of segments.\\

This is trivial to do for closure since it is a single integral
and therefore is completely linear w.r.t. different segment of the integrand.
The gradient of the integral on one segment is directly that on the final result
and is independent of the functional form in any other segments.\\

The enclosed area, and the average displacement, is more complicated however,
since they involve a double integral so the gradient of the integral
within the segment is not the same as the effect on the final value.
(Actually the average displacment could be calculated as a single integeral
by flipping the order of the two integrals or undo the integral by part
done above.) The change is still linear but does require a conversion factor
caused by the later segments.\\

To calculate this, let's first consider a generic double integral
\eqar{
  I=&\int_0^T\!\!\ud t\ A(t)\int_0^t\!\!\ud t'\ B(t')
}
which should cover both cases we are interested above
with the appropriate definition of the $A$ and $B$ functions.\\

Now let's assume that there are $N_s$ segments. The $n$-th one starts
at $t_{n}$ and ends at $t_{n+1}$ with $t_0=0$ and $t_{N_s}=T$.
\eqar{
  I=&\int_0^T\!\!\ud t\ A(t)\int_0^t\!\!\ud t'\ B(t')\\
  =&\sum_{n=0}^{N_s-1}\int_{t_{n}}^{t_{n+1}}\!\!\ud t\ A(t)\int_0^t\!\!\ud t'\ B(t')\\
  =&\sum_{n=0}^{N_s-1}\int_{t_{n}}^{t_{n+1}}\!\!\ud t\ A(t)
  \paren{\sum_{n'=0}^{n-1}\int_{t_{n'}}^{t_{n'+1}}\!\!\ud t'\ B(t')+\int_{t_n}^{t}\!\!\ud t'\ B(t')}\\
  =&\sum_{n=0}^{N_s-1}\sum_{n'=0}^{n-1}\int_{t_{n}}^{t_{n+1}}\!\!\ud t\ A(t)
  \int_{t_{n'}}^{t_{n'+1}}\!\!\ud t'\ B(t')+\sum_{n=0}^{N_s-1}\int_{t_{n}}^{t_{n+1}}\!\!\ud t\ A(t)\int_{t_n}^{t}\!\!\ud t'\ B(t')\\
  =&\sum_{n=0}^{N_s-1}\sum_{n'=0}^{n-1}A_{n}B_{n'}+\sum_{n=0}^{N_s-1}C_n
}
where $A_n\equiv\dint_{t_n}^{t_{n+1}}A(t)\ud t$, $B_n\equiv\dint_{t_n}^{t_{n+1}}B(t)\ud t$,
and $C_n\equiv\dint_{t_{n}}^{t_{n+1}}\!\!\ud t\ A(t)\dint_{t_n}^{t}\!\!\ud t'\ B(t')$.
All three of these values only depend on the value of the $A$ and $B$ functions
within the corresponding segments and can be computed with $\mathcal{O}(1)$ time.
Moreover, by pre-computing the $\dsum_{n'=0}^{n-1}B_{n'}$ values ($N_s-1$ values in total),
the two dimentional summation can be computed in $\mathcal{O}(N_s)$ time
and therefore the whole expression can be computed within $\mathcal{O}(N_s)$ time.\\

As for the derivatives, the derivatives of $A_n$, $B_n$, $C_n$ w.r.t.
the corresponding parameters can be computed within $\mathcal{O}(N_p)$ time.
We then have
\eqar{
  \pdiff{I}{A_n}=&\sum_{n'=0}^{n-1}B_{n'}\\
  \pdiff{I}{B_n}=&\sum_{n'=0}^{N_s-1}\sum_{n''=0}^{n'-1}A_{n'}\delta_{n,n''}\\
  =&\sum_{n'=n+1}^{N_s-1}A_{n'}\\
  \pdiff{I}{C_n}=&1
}
which can be all computed within $\mathcal{O}(N_s)$ time so the full set of
all direvatives can be computed within $\mathcal{O}(N_s+N_p)$ time.

\subsection{Segment evaluation}
Let's limit the pulse shape we support within each segment to linear in terms of
amplitude and phase (note that a linear phase ramp is a constant frequency shift,
linear frequency ramp isn't currently supported).
Under these assumptions, the most generic nontrivial form of $A$ and $B$
we need to deal with is
\eqar{
  &(a_0t + b_0)\ue^{\ui \paren{\omega t + \varphi_0}}
}
Combining $A_i$, $B_i$ and $C_i$, we actually care about the integral
$\displaystyle F_n(\omega, t)\equiv\int t^n\ue^{\ui\omega t}\ud t$
up to $n=2$ order (see below) (the phase factor $\varphi_0$ is ignored
since it's just a global multiplicity factor). From symbolic evaluation we have,
\eqar{
  F_0(\omega, t)=&\frac{-\ui}{\omega}\ue^{\ui\omega t}\\
  F_1(\omega, t)=&\frac{-\ui\omega t + 1}{\omega^2}\ue^{\ui\omega t}\\
  F_2(\omega, t)=&\frac{-\ui\omega^2t^2+2\omega t+2\ui}{\omega^3}\ue^{\ui\omega t}
}
We also have
\eqar{
  \pdiff{F_n(\omega, t)}{t}=&t^n\ue^{\ui\omega t}\\
  \pdiff{F_n(\omega, t)}{\omega}=&\ui F_{n+1}(\omega, t)
}

For a pulse sequence where the amplitude and phase of the pulse are given by
\eqar{
  \Omega(t)=&\Omega_n+\Omega'_n\paren{t-t_n}&(t_n\leqslant t<t_{n+1})\\
  \theta(t)=&\theta_n+\bar\omega_n\paren{t-t_n}&(t_n\leqslant t<t_{n+1})
}
where $\bar\omega_n$ is the motional drive frequency from the laser
(half of red-blue sideband difference) during the $n$-th segment.\\

For closure, the shift within each segment is,
\eqar{
  \alpha_k^n\equiv&\int_{t_n}^{t_{n+1}}\Omega(t)\ue^{\ui\theta_k(t)}\ud t\\
  =&\int_{t_n}^{t_{n+1}}\paren{\Omega_n+\Omega'_n\paren{t-t_n}}\ue^{\ui\paren{\omega_kt-\theta_n-\bar\omega_n\paren{t-t_n}}}\ud t\\
  =&\int_{0}^{\tau_n}\paren{\Omega_n+\Omega'_n t}\ue^{\ui\paren{\omega_kt+\varphi_k^n-\bar\omega_n t}}\ud t\\
  =&\ue^{\ui\varphi_k^n}\paren{\Omega_nF_0(\delta_k^n, \tau_n)+\Omega'_nF_1(\delta_k^n, \tau_n)-\Omega_nF_0(\delta_k^n, 0)-\Omega'_nF_1(\delta_k^n, 0)}\\
  =&\frac{\ue^{\ui\varphi_k^n}}{{\delta_k^n}^2}\paren{
    \paren{-\ui\Omega_n\delta_k^n+\Omega'_n}\paren{\ue^{\ui\delta_k^n\tau_n}-1}
    -\ui\Omega'_n\delta_k^n\tau_n\ue^{\ui\delta_k^n\tau_n}}
}
where $\tau_n\equiv t_{n+1}-t_n$ is the length of the $n$-th segment, $\delta_k^n\equiv\omega_k-\bar\omega_n$ is the detuning of the $n$-th segment from the $k$-th mode, $\varphi_k^n\equiv\omega_kt_n-\theta_n$ is the initial phase difference with the $k$-th mode at the beginning of the $n$-th segment.\\

We can further transform this into a form that is easier to evaluate
around $\delta_k^n=0$,
\eqar{
  \alpha_k^n=&\ue^{\ui\varphi_k^n}\lparen{
    \Omega'_n\tau_n^2\frac{\cos\paren{\delta_k^n\tau_n}-1}{{\delta_k^n}^2\tau_n^2}
    +\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}\frac{\sin\paren{\delta_k^n\tau_n}}{\delta_k^n\tau_n}
  }\\
  &\rparen{
    -\ui\Omega_n\delta_k^n\tau_n^2\frac{\cos\paren{\delta_k^n\tau_n}-1}{{\delta_k^n}^2\tau_n^2}
    -\ui\Omega'_n\tau_n^2\frac{\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
  }\\
  =&\ue^{\ui\varphi_k^n}\paren{
    \paren{\ui\Omega_n\delta_k^n\tau_n^2-\Omega'_n\tau_n^2}\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}\mathrm{sinc}\paren{\delta_k^n\tau_n}
    -\ui\Omega'_n\tau_n^2\mathrm{cosc}\paren{\delta_k^n\tau_n}
  }
}

The final closure is the sum of the value within each segment,
\eqar{
  \alpha_k(T)=&\sum_{n=0}^{N_s-1}\alpha_k^n
}

For the average displacement, the $A_n$ terms are simply $\tau_n$ and the $B_n$ terms
are $\alpha_k^n$. The $C_n$ terms has to be computed,
\eqar{
  \bar\alpha_k^n=&\int_{t_{n}}^{t_{n+1}}\!\!\ud t\int_{t_n}^{t}\!\!\ud t'\ \Omega(t')\ue^{\ui\theta_k(t')}\\
  =&\int_{0}^{\tau_n}\!\!\ud t\int_{t_n}^{t_n+t}\!\!\ud t'\ \paren{\Omega_n+\Omega'_n\paren{t'-t_n}}\ue^{\ui\paren{\omega_kt'-\theta_n-\bar\omega_n\paren{t'-t_n}}}\\
  =&\ue^{\ui\varphi_k^n}\int_{0}^{\tau_n}\!\!\ud t\int_{0}^{t}\!\!\ud t'\ \paren{\Omega_n+\Omega'_n t'}\ue^{\ui\delta_k^nt'}\\
  =&\frac{\ue^{\ui\varphi_k^n}}{{\delta_k^n}^2}\int_{0}^{\tau_n}\!\!\ud t
  \paren{\paren{\Omega'_n-\ui\Omega_n\delta_k^n-\ui\Omega'_n\delta_k^nt}\ue^{\ui\delta_k^nt}-\paren{\Omega'_n-\ui\Omega_n\delta_k^n}}\\
  =&\frac{\ue^{\ui\varphi_k^n}}{{\delta_k^n}^2}
  \lparen{\paren{\Omega'_n-\ui\Omega_n\delta_k^n}F_0(\delta_k^n, \tau_n)-\ui\Omega'_n\delta_k^nF_1(\delta_k^n, \tau_n)}\\
  &\rparen{-\paren{\Omega'_n-\ui\Omega_n\delta_k^n}F_0(\delta_k^n, 0)+\ui\Omega'_n\delta_k^nF_1(\delta_k^n, 0)-\paren{\Omega'_n-\ui\Omega_n\delta_k^n}\tau_n}\\
  =&\frac{\ue^{\ui\varphi_k^n}}{{\delta_k^n}^2}
  \paren{\frac{-\Omega_n\delta_k^n-2\ui\Omega'_n}{{\delta_k^n}}\paren{\ue^{\ui{\delta_k^n}\tau_n} - 1}-\Omega'_n\tau_n\ue^{\ui{\delta_k^n}\tau_n}-\paren{\Omega'_n-\ui\Omega_n\delta_k^n}\tau_n}
}

Again, for an better expression around $\delta_k^n=0$,
\eqar{
  \bar\alpha_k^n=&\frac{\ue^{\ui\varphi_k^n}}{{\delta_k^n}^2}
  \lparen{
    -\Omega_n\paren{\cos\paren{{\delta_k^n}\tau_n}-1}
    +\frac{2\Omega'_n\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}}
    -\Omega'_n\tau_n\cos\paren{{\delta_k^n}\tau_n}
    -\Omega'_n\tau_n
  }\\
  &\rparen{
    -\ui\Omega_n\sin\paren{{\delta_k^n}\tau_n}
    -2\ui\frac{\Omega'_n\paren{\cos\paren{{\delta_k^n}\tau_n}-1}}{{\delta_k^n}}
    -\ui\Omega'_n\tau_n\sin\paren{{\delta_k^n}\tau_n}
    +\ui\Omega_n\delta_k^n\tau_n
  }\\
  =&\ue^{\ui\varphi_k^n}\tau_n
  \lparen{
    \Omega_n\tau_n\frac{1-\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\Omega'_n\tau_n^2\frac{2\sin\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n
    }{{\delta_k^n}^3\tau_n^3}
  }\\
  &\rparen{
    +\ui\Omega_n\tau_n\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
    -\ui\Omega'_n\tau_n^2\frac{2\cos\paren{{\delta_k^n}\tau_n}-2+\delta_k^n\tau_n\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }
}

For the enclosed area, the $A_n$ and $B_n$ terms are both the $\alpha_k^n$
computed above. The $C_n$ terms,
\eqar{
  \gamma_k^n\equiv&\int_{t_{n}}^{t_{n+1}}\!\!\ud t\ \Omega(t)\ue^{\ui\theta_k(t)}\int_{t_n}^{t}\!\!\ud t'\ \Omega(t')\ue^{-\ui\theta_k(t')}\\
  =&\int_{t_{n}}^{t_{n+1}}\!\!\ud t\ \paren{\Omega_n+\Omega'_n\paren{t-t_n}}\ue^{\ui\paren{\omega_kt-\theta_n-\bar\omega_n\paren{t-t_n}}}\int_{t_n}^{t}\!\!\ud t'\ \paren{\Omega_n+\Omega'_n\paren{t'-t_n}}\ue^{-\ui\paren{\omega_kt'-\theta_n-\bar\omega_n\paren{t'-t_n}}}\\
  =&\int_{0}^{\tau_n}\!\!\ud t\ \paren{\Omega_n+\Omega'_nt}\ue^{\ui\delta_k^nt}\int_{0}^{t}\!\!\ud t'\ \paren{\Omega_n+\Omega'_nt'}\ue^{-\ui\delta_k^nt'}\\
  =&\int_{0}^{\tau_n}\!\!\ud t\ \paren{\Omega_n+\Omega'_nt}\ue^{\ui\delta_k^nt}
  \paren{\paren{\frac{\Omega'_n+\ui\Omega_n\delta_k^n}{{\delta_k^n}^2}+\ui\frac{\Omega'_nt}{\delta_k^n}}\ue^{-\ui\delta_k^nt}-\frac{\Omega'_n+\ui\Omega_n\delta_k^n}{{\delta_k^n}^2}}\\
  =&\frac{1}{{\delta_k^n}^2}\int_{0}^{\tau_n}\!\!\ud t
  \ \paren{
    \paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega_n
    +\paren{\Omega'_n+2\ui\Omega_n\delta_k^n}\Omega'_nt
    +\ui{\Omega'_n}^2\delta_k^nt^2
    -\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\paren{\Omega_n+\Omega'_nt}
    \ue^{\ui\delta_k^nt}}\\
  =&\frac{1}{{\delta_k^n}^2}
  \lparen{\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega_n\tau_n+\frac{1}{2}\paren{\Omega'_n+2\ui\Omega_n\delta_k^n}\Omega'_n\tau_n^2+\frac{1}{3}\ui{\Omega'_n}^2\delta_k^n\tau_n^3}\\
  &\rparen{-\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega_n\paren{F_0(\delta_k^n, \tau_n)-F_0(\delta_k^n, 0)}-\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega'_n\paren{F_1(\delta_k^n, \tau_n)-F_1(\delta_k^n, 0)}}\\
  =&\frac{1}{{\delta_k^n}^2}
  \lparen{\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega_n\tau_n+\frac{1}{2}\paren{\Omega'_n+2\ui\Omega_n\delta_k^n}\Omega'_n\tau_n^2+\frac{1}{3}\ui{\Omega'_n}^2\delta_k^n\tau_n^3}\\
  &\rparen{+\frac{\ui}{{\delta_k^n}}\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega_n
    \paren{\ue^{\ui{\delta_k^n}\tau_n}-1}
    -\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega'_n
    \paren{\frac{-\ui{\delta_k^n}\tau_n + 1}{{\delta_k^n}^2}\ue^{\ui{\delta_k^n}\tau_n}
      -\frac{1}{{\delta_k^n}^2}}}\\
  =&\frac{1}{{\delta_k^n}^2}
  \lparen{\paren{\Omega'_n+\ui\Omega_n\delta_k^n}\Omega_n\tau_n+\frac{1}{2}\paren{\Omega'_n+2\ui\Omega_n\delta_k^n}\Omega'_n\tau_n^2+\frac{1}{3}\ui{\Omega'_n}^2\delta_k^n\tau_n^3}\\
  &\rparen{-\frac{1}{{\delta_k^n}^2}\paren{\Omega_n^2{\delta_k^n}^2+{\Omega'_n}^2}
    \paren{\ue^{\ui{\delta_k^n}\tau_n}-1}
    +\ui\paren{\Omega'_n+\ui\Omega_n\delta_k^n}
    \frac{\Omega'_n\tau_n}{{\delta_k^n}}\ue^{\ui{\delta_k^n}\tau_n}
  }
}
For an better expression around $\delta_k^n=0$,
\eqar{
  \gamma_k^n=&\frac{1}{{\delta_k^n}^2}
  \lparen{
    \paren{\Omega_n^2+\Omega_n\Omega'_n\tau_n}\paren{1-\cos\paren{{\delta_k^n}\tau_n}}
    +{\Omega'_n}^2\frac{{\delta_k^n}^2\tau_n^2/2+1-\cos\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2}
  }\\
  &\rparen{
    +\ui\paren{\Omega_n^2+\Omega_n\Omega'_n\tau_n}\paren{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}
    +\ui{\Omega'_n}^2\frac{
      {\delta_k^n}^3\tau_n^3/3
      -\sin\paren{{\delta_k^n}\tau_n}
      +{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^2}
  }\\
  =&\paren{\Omega_n^2\tau_n^2+\Omega_n\Omega'_n\tau_n^3}\frac{1-\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
  +{\Omega'_n}^2\tau_n^4\frac{{\delta_k^n}^2\tau_n^2/2+1-\cos\paren{{\delta_k^n}\tau_n}
    -{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^4\tau_n^4}\\
  &+\ui\paren{\Omega_n^2\tau_n^2+\Omega_n\Omega'_n\tau_n^3}\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
  +\ui{\Omega'_n}^2\tau_n^4\frac{
    {\delta_k^n}^3\tau_n^3/3
    -\sin\paren{{\delta_k^n}\tau_n}
    +{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^4\tau_n^4}
}

Now the gradients w.r.t. mode frequency/detuning.
\eqar{
  \pdiff{\alpha_k^n}{\delta_k^n}=&\ue^{\ui\varphi_k^n}\pdiff{}{\delta_k^n}\paren{
    \paren{\ui\Omega_n\delta_k^n\tau_n^2-\Omega'_n\tau_n^2}\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}\mathrm{sinc}\paren{\delta_k^n\tau_n}
    -\ui\Omega'_n\tau_n^2\mathrm{cosc}\paren{\delta_k^n\tau_n}
  }\\
  =&\ue^{\ui\varphi_k^n}\tau_n\lparen{
    \ui\Omega_n\tau_n\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\paren{\ui\Omega_n\delta_k^n\tau_n^2-\Omega'_n\tau_n^2}
    \frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}
  }\\
  &\rparen{
    +\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}\mathrm{cosc}\paren{\delta_k^n\tau_n}
    +\ui\Omega'_n\tau_n^2
    \frac{\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{\delta_k^n\tau_n}+2\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }
}

Area (we'll ignore the real part of the integral since we don't need it),
\eqar{
  \pdiff{\mathrm{Im}\paren{\gamma_k^n}}{\delta_k^n}=&
  \paren{\Omega_n^2\tau_n^2+\Omega_n\Omega'_n\tau_n^3}\pdiff{}{\delta_k^n}\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}\\
  &+{\Omega'_n}^2\tau_n^4\pdiff{}{\delta_k^n}\frac{
    {\delta_k^n}^3\tau_n^3/3
    -\sin\paren{{\delta_k^n}\tau_n}
    +{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^4\tau_n^4}\\
  =&\tau_n\lparen{
    \paren{\Omega_n^2\tau_n^2+\Omega_n\Omega'_n\tau_n^3}
    \frac{-\delta_k^n\tau_n+2\sin\paren{{\delta_k^n}\tau_n}-{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }\\
  &\rparen{+{\Omega'_n}^2\tau_n^4\frac{
      -{\delta_k^n}^3\tau_n^3/3
      +\paren{4-{\delta_k^n}^2\tau_n^2}\sin\paren{{\delta_k^n}\tau_n}
      -4{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^5\tau_n^5}
  }
}

The gradients w.r.t. other control parameters, displacement,
\eqar{
  \pdiff{\alpha_k^n}{\tau_n}=&\ue^{\ui\varphi_k^n}\lparen{
    \paren{\ui\Omega_n\delta_k^n-\Omega'_n}\pdiff{}{\tau_n}\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
    +\pdiff{\Omega_n+\Omega'_n\tau_n}{\tau_n}
    \frac{\sin\paren{\delta_k^n\tau_n}}{\delta_k^n}
  }\\
  &\rparen{
    +\paren{\Omega_n+\Omega'_n\tau_n}
    \pdiff{}{\tau_n}\frac{\sin\paren{\delta_k^n\tau_n}}{\delta_k^n}
    -\ui\Omega'_n
    \pdiff{}{\tau_n}\frac{\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
  }\\
  =&\ue^{\ui\varphi_k^n}\paren{
    \paren{\ui\Omega_n\delta_k^n-\Omega'_n}\frac{\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}}
    +\Omega'_n\frac{\sin\paren{\delta_k^n\tau_n}}{\delta_k^n}+\paren{\Omega_n+\Omega'_n\tau_n}
    \cos\paren{\delta_k^n\tau_n}
    +\ui\Omega'_n\tau_n\sin\paren{\delta_k^n\tau_n}
  }\\
  =&\ue^{\ui\varphi_k^n}\paren{
    \paren{\Omega_n+\Omega'_n\tau_n}\cos\paren{\delta_k^n\tau_n}
    +\ui\paren{\Omega_n+\Omega'_n\tau_n}\sin\paren{\delta_k^n\tau_n}
  }
}
\eqar{
  \pdiff{\alpha_k^n}{\varphi_k^n}=&\ui\alpha_k^n
}
\eqar{
  \pdiff{\alpha_k^n}{\Omega_n}=&\ue^{\ui\varphi_k^n}\tau_n\paren{
    \ui\delta_k^n\tau_n\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\mathrm{sinc}\paren{\delta_k^n\tau_n}
  }
}
\eqar{
  \pdiff{\alpha_k^n}{\Omega'_n}=&\ue^{\ui\varphi_k^n}\tau_n^2\paren{
    -\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\mathrm{sinc}\paren{\delta_k^n\tau_n}
    -\ui\mathrm{cosc}\paren{\delta_k^n\tau_n}
  }
}

Cumulative displacement,
\eqar{
  \pdiff{\bar\alpha_k^n}{\tau_n}=&\ue^{\ui\varphi_k^n}
  \lparen{
    \Omega_n\pdiff{}{\tau_n}\frac{1-\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2}
    +\Omega'_n\pdiff{}{\tau_n}\frac{2\sin\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n
    }{{\delta_k^n}^3}
  }\\
  &\rparen{
    +\ui\Omega_n\pdiff{}{\tau_n}\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2}
    -\ui\Omega'_n\pdiff{}{\tau_n}\frac{2\cos\paren{{\delta_k^n}\tau_n}-2+\delta_k^n\tau_n\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3}
  }\\
  =&\ue^{\ui\varphi_k^n}
  \lparen{
    \Omega_n\frac{\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}}
    +\Omega'_n\frac{
      \cos\paren{{\delta_k^n}\tau_n}
      +{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
      -1
    }{{\delta_k^n}^2}
  }\\
  &\rparen{
    +\ui\Omega_n\frac{
      1-\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}}
    +\ui\Omega'_n\frac{
      \sin\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^2}
  }\\
  =&\ue^{\ui\varphi_k^n}
  \lparen{
    \paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}\frac{\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}\tau_n}
    -\Omega'_n\tau_n^2\frac{
      1-\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^2\tau_n^2}
  }\\
  &\rparen{
    +\ui\Omega_n\tau_n\frac{
      1-\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}\tau_n}
    +\ui\Omega'_n\tau_n^2\frac{
      \sin\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^2\tau_n^2}
  }
}
\eqar{
  \pdiff{\bar\alpha_k^n}{\varphi_k^n}=&\ui\bar\alpha_k^n
}
\eqar{
  \pdiff{\bar\alpha_k^n}{\Omega_n}=&\ue^{\ui\varphi_k^n}\tau_n^2
  \paren{
    \frac{1-\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\ui\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
  }
}
\eqar{
  \pdiff{\bar\alpha_k^n}{\Omega'_n}=&\ue^{\ui\varphi_k^n}\tau_n^3
  \paren{
    \frac{2\sin\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
      -{\delta_k^n}\tau_n
    }{{\delta_k^n}^3\tau_n^3}
    -\ui\frac{2\cos\paren{{\delta_k^n}\tau_n}-2+\delta_k^n\tau_n\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }
}
\eqar{
  \pdiff{\bar\alpha_k^n}{\delta_k^n}=&\ue^{\ui\varphi_k^n}\tau_n^2
  \lparen{
    -\Omega_n\tau_n\frac{2-2\cos\paren{{\delta_k^n}\tau_n}-{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }\\
  &-\Omega'_n\tau_n^2\frac{
    \paren{6-{\delta_k^n}^2\tau_n^2}\sin\paren{{\delta_k^n}\tau_n}
    -2{\delta_k^n}\tau_n
    -4{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^4\tau_n^4}\\
  &+\ui\Omega_n\tau_n\frac{2\sin\paren{{\delta_k^n}\tau_n}-\delta_k^n\tau_n-\delta_k^n\tau_n\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}\\
  &\rparen{
    +\ui\Omega'_n\tau_n^2\frac{
      \paren{6-{\delta_k^n}^2\tau_n^2}\cos\paren{{\delta_k^n}\tau_n}
      -6
      +4{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^4\tau_n^4}
  }
}
Area,
\eqar{
  \pdiff{\mathrm{Im}\paren{\gamma_k^n}}{\tau_n}=&\pdiff{}{\tau_n}\paren{\Omega_n^2+\Omega_n\Omega'_n\tau_n}\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2}
  +{\Omega'_n}^2\pdiff{}{\tau_n}\frac{
    {\delta_k^n}^3\tau_n^3/3
    -\sin\paren{{\delta_k^n}\tau_n}
    +{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^4}\\
  =&\Omega_n\Omega'_n\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2}
  +\paren{\Omega_n^2+\Omega_n\Omega'_n\tau_n}\frac{
    1-\cos\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}}
  +{\Omega'_n}^2\tau_n\frac{
    {\delta_k^n}\tau_n
    -\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^2}\\
  =&\paren{\Omega_n\Omega'_n\tau_n^2+{\Omega'_n}^2\tau_n^3}\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
  +\paren{\Omega_n^2\tau_n+\Omega_n\Omega'_n\tau_n^2}\frac{
    1-\cos\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}\tau_n}
}
\eqar{
  \pdiff{}{\varphi_n}\mathrm{Im}\paren{\gamma_k^n}=&0
}
\eqar{
  \pdiff{\mathrm{Im}\paren{\gamma_k^n}}{\Omega_n}=&\tau_n\paren{2\Omega_n\tau_n+\Omega'_n\tau_n^2}\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
}
\eqar{
  \pdiff{\mathrm{Im}\paren{\gamma_k^n}}{\Omega'_n}=&\tau_n^2\paren{\Omega_n\tau_n\frac{\delta_k^n\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +2{\Omega'_n}\tau_n^2\frac{
      {\delta_k^n}^3\tau_n^3/3
      -\sin\paren{{\delta_k^n}\tau_n}
      +{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^4\tau_n^4}}
}

Displacement gradient w.r.t. mode frequency,
\eqar{
  \frac{\partial^2\alpha_k^n}{\partial\delta_k^n\partial\tau_n}=&\ue^{\ui\varphi_k^n}\pdiff{}{\tau_n}\lparen{
    \ui\Omega_n\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
    +\paren{\ui\Omega_n\delta_k^n-\Omega'_n}
    \frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3}
  }\\
  &\rparen{
    +\paren{\Omega_n+\Omega'_n\tau_n}
    \frac{{\delta_k^n\tau_n}\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
    +\ui\Omega'_n
    \frac{\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{\delta_k^n\tau_n}+2\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^3}
  }\\
  =&\ue^{\ui\varphi_k^n}\lparen{
    \ui\Omega_n\pdiff{}{\tau_n}\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
    +\paren{\ui\Omega_n\delta_k^n-\Omega'_n}
    \pdiff{}{\tau_n}\frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3}
  }\\
  &+\Omega'_n
  \frac{{\delta_k^n\tau_n}\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
  +\paren{\Omega_n+\Omega'_n\tau_n}
  \pdiff{}{\tau_n}\frac{{\delta_k^n\tau_n}\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
  \\
  &\rparen{
    +\ui\Omega'_n
    \pdiff{}{\tau_n}\frac{\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{\delta_k^n\tau_n}+2\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^3}
  }\\
  =&\ue^{\ui\varphi_k^n}\lparen{
    \ui\Omega_n\frac{\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}}
    +\paren{\ui\Omega_n\delta_k^n-\Omega'_n}
    \frac{
      {\delta_k^n}\tau_n\cos\paren{\delta_k^n\tau_n}
      -\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
  }\\
  &\rparen{
    +\Omega'_n
    \frac{{\delta_k^n\tau_n}\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2}
    -\paren{\Omega_n+\Omega'_n\tau_n}\tau_n\sin\paren{\delta_k^n\tau_n}
    +\ui\Omega'_n\tau_n^2\cos\paren{\delta_k^n\tau_n}
  }\\
  =&\ue^{\ui\varphi_k^n}\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}\paren{
    \ui\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}
  }
}
\eqar{
  \frac{\partial^2\alpha_k^n}{\partial\delta_k^n\partial\varphi_k^n}=&\ui\pdiff{\alpha_k^n}{\delta_k^n}
}
\eqar{
  \frac{\partial^2\alpha_k^n}{\partial\delta_k^n\partial\Omega_n}=&\ue^{\ui\varphi_k^n}\tau_n^2\paren{
    \ui\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\ui\delta_k^n\tau_n
    \frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}+\mathrm{cosc}\paren{\delta_k^n\tau_n}
  }
}
\eqar{
  \frac{\partial^2\alpha_k^n}{\partial\delta_k^n\partial\Omega'_n}=&\ue^{\ui\varphi_k^n}\tau_n^3\lparen{
    -\frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}
    +\mathrm{cosc}\paren{\delta_k^n\tau_n}
  }\\
  &\rparen{
    +\ui\frac{\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{\delta_k^n\tau_n}+2\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }
}
\eqar{
  \pdiff[2]{\alpha_k^n}{\delta_k^n}=&\ue^{\ui\varphi_k^n}\tau_n\lparen{
    \ui\Omega_n\tau_n\pdiff{}{\delta_k^n}\frac{1-\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}
    +\ui\Omega_n\tau_n^2
    \frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}
  }\\
  &+\paren{\ui\Omega_n\delta_k^n\tau_n^2-\Omega'_n\tau_n^2}
  \pdiff{}{\delta_k^n}\frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}
  \\
  &+\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}
  \pdiff{}{\delta_k^n}\frac{\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}-\sin\paren{\delta_k^n\tau_n}}{{\delta_k^n}^2\tau_n^2}\\
  &\rparen{
    +\ui\Omega'_n\tau_n^2
    \pdiff{}{\delta_k^n}\frac{\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{\delta_k^n\tau_n}+2\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }\\
  =&\ue^{\ui\varphi_k^n}\tau_n^2\lparen{
    \ui\Omega_n\tau_n
    \frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}
    +\ui\Omega_n\tau_n
    \frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}
  }\\
  &-\paren{\ui\Omega_n\delta_k^n\tau_n^2-\Omega'_n\tau_n^2}
  \frac{
    \paren{6-{\delta_k^n}^2\tau_n^2}\cos\paren{{\delta_k^n}\tau_n}
    -6+4{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^4\tau_n^4}
  \\
  &-\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}
  \frac{\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{\delta_k^n\tau_n}+2\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^3\tau_n^3}\\
  &\rparen{
    -\ui\Omega'_n\tau_n^2
    \frac{
      {\delta_k^n}\tau_n\paren{6-{\delta_k^n}^2\tau_n^2}\cos\paren{{\delta_k^n}\tau_n}
      +3\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^4\tau_n^4}
  }\\
  =&\ue^{\ui\varphi_k^n}\tau_n^2\lparen{
    \ui 2\Omega_n\tau_n
    \frac{\delta_k^n\tau_n\sin\paren{\delta_k^n\tau_n}+2\cos\paren{\delta_k^n\tau_n}-2}{{\delta_k^n}^3\tau_n^3}
  }\\
  &-\paren{\ui\Omega_n\delta_k^n\tau_n^2-\Omega'_n\tau_n^2}
  \frac{
    \paren{6-{\delta_k^n}^2\tau_n^2}\cos\paren{{\delta_k^n}\tau_n}
    -6+4{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^4\tau_n^4}
  \\
  &-\paren{\Omega_n\tau_n+\Omega'_n\tau_n^2}
  \frac{\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{\delta_k^n\tau_n}+2\delta_k^n\tau_n\cos\paren{\delta_k^n\tau_n}}{{\delta_k^n}^3\tau_n^3}\\
  &\rparen{
    -\ui\Omega'_n\tau_n^2
    \frac{
      {\delta_k^n}\tau_n\paren{6-{\delta_k^n}^2\tau_n^2}\cos\paren{{\delta_k^n}\tau_n}
      +3\paren{{\delta_k^n}^2\tau_n^2-2}\sin\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^4\tau_n^4}
  }
}

Area gradient w.r.t. mode frequency,
\eqar{
  \frac{\partial^2\mathrm{Im}\paren{\gamma_k^n}}{\partial\delta_k^n\partial\tau_n}=&
  \pdiff{}{\tau_n}\lparen{
    \paren{\Omega_n^2+\Omega_n\Omega'_n\tau_n}
    \frac{-\delta_k^n\tau_n+2\sin\paren{{\delta_k^n}\tau_n}-{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3}
  }\\
  &\rparen{+{\Omega'_n}^2\frac{
      -{\delta_k^n}^3\tau_n^3/3
      +\paren{4-{\delta_k^n}^2\tau_n^2}\sin\paren{{\delta_k^n}\tau_n}
      -4{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^5}
  }\\
  =&\Omega_n\Omega'_n\frac{-\delta_k^n\tau_n+2\sin\paren{{\delta_k^n}\tau_n}-{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3}
  \\
  &+\paren{\Omega_n^2+\Omega_n\Omega'_n\tau_n}
  \frac{-1+2\cos\paren{{\delta_k^n}\tau_n}
    -\cos\paren{{\delta_k^n}\tau_n}
    +{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^2}
  \\
  &+{\Omega'_n}^2\frac{
    -{\delta_k^n}^2\tau_n^2
    -2{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
    +\paren{4-{\delta_k^n}^2\tau_n^2}\cos\paren{{\delta_k^n}\tau_n}
    -4\cos\paren{{\delta_k^n}\tau_n}
    +4{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^4}
  \\
  =&\Omega_n\Omega'_n\frac{-\delta_k^n\tau_n+2\sin\paren{{\delta_k^n}\tau_n}-{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3}
  \\
  &+\paren{\Omega_n^2+\Omega_n\Omega'_n\tau_n}
  \frac{-1
    +\cos\paren{{\delta_k^n}\tau_n}
    +{\delta_k^n}\tau_n\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^2}
  \\
  &+{\Omega'_n}^2\tau_n\frac{
    -{\delta_k^n}\tau_n
    -{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    +2\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^3}
  \\
  =&\Omega_n^2\tau_n^2\paren{
    \frac{\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}\tau_n}
    -\frac{1-\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^2\tau_n^2}
  }
  \\
  &+\Omega_n\Omega'_n\tau_n^3\paren{
    \frac{\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}\tau_n}
    -2\frac{{\delta_k^n}\tau_n-\sin\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }
  \\
  &+{\Omega'_n}^2\tau_n^4\frac{
    -{\delta_k^n}\tau_n
    -{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    +2\sin\paren{{\delta_k^n}\tau_n}
  }{{\delta_k^n}^3\tau_n^3}
}
\eqar{
  \frac{\partial^2\mathrm{Im}\paren{\gamma_k^n}}{\partial\delta_k^n\partial\varphi_k^n}=&0
}
\eqar{
  \frac{\partial^2\mathrm{Im}\paren{\gamma_k^n}}{\partial\delta_k^n\partial\Omega_n}=&\tau_n^2\paren{2\Omega_n\tau_n+\Omega'_n\tau_n^2}
  \frac{-\delta_k^n\tau_n+2\sin\paren{{\delta_k^n}\tau_n}-{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}
}
\eqar{
  \frac{\partial^2\mathrm{Im}\paren{\gamma_k^n}}{\partial\delta_k^n\partial\Omega'_n}=&\tau_n^3\lparen{
    \Omega_n\tau_n
    \frac{-\delta_k^n\tau_n+2\sin\paren{{\delta_k^n}\tau_n}-{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}}{{\delta_k^n}^3\tau_n^3}
  }\\
  &\rparen{+2\Omega'_n\tau_n^2\frac{
      -{\delta_k^n}^3\tau_n^3/3
      +\paren{4-{\delta_k^n}^2\tau_n^2}\sin\paren{{\delta_k^n}\tau_n}
      -4{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^5\tau_n^5}
  }
}
\eqar{
  \frac{\partial^2\mathrm{Im}\paren{\gamma_k^n}}{{\partial\delta_k^n}^2}=&\tau_n^2\lparen{
    -\paren{\Omega_n^2\tau_n^2+\Omega_n\Omega'_n\tau_n^3}
    \frac{
      \paren{6-{\delta_k^n}^2\tau_n^2}\sin\paren{{\delta_k^n}\tau_n}
      -2{\delta_k^n}\tau_n-4{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^4\tau_n^4}
  }\\
  &\rparen{-{\Omega'_n}^2\tau_n^4
    \frac{
      -2{\delta_k^n}^3\tau_n^3/3
      +\paren{20-7{\delta_k^n}^2\tau_n^2}\sin\paren{{\delta_k^n}\tau_n}
      -\paren{20-{\delta_k^n}^2\tau_n^2}{\delta_k^n}\tau_n\cos\paren{{\delta_k^n}\tau_n}
    }{{\delta_k^n}^5\tau_n^5}
  }
}

\subsection{Segment summation}
Here we list the explicit expressions for calculating the final values we care about
by summation of the segment values we've calculated above.\\

All of the expressions below can be computed in $O(N_s)$ time by pre-computing
the partial sums that appears in the nested summation expressions.\\

A few partial sums that are used frequently below,
\eqar{
  A_k^n=&\sum_{n'=0}^{n-1}\!\!\alpha_k^{n'}\\
  T_n=&\sum_{n'=0}^{n-1}\!\!\tau_{n'}
}

We also make frequent use of the following identity below
\eqar{
  \sum_{n=0}^{N_s-1}\sum_{n'=0}^{n'-1}=\sum_{n'=0}^{N_s-1}\sum_{n=n'+1}^{N_s-1}
}

Total displacement
\eqar{
  \alpha_k=&A_k^{N_s-1}
}

Total area,
\eqar{
  \mathrm{Im}(\gamma_k)=&\sum_{n=0}^{N_s-1}\!\!\paren{\mathrm{Im}\paren{\alpha_k^n{A_k^n}^*}+\mathrm{Im}(\gamma_k^n)}
}

Average (actually cumulative) displacement,
\eqar{
  \bar\alpha_k=&\sum_{n=0}^{N_s-1}\!\!\paren{\tau_n A_k^n+\bar\alpha_k^n}
}

Note that changing the mode frequency will change the initial phase for
all the segments by an amount proportional to the start time of the segment.
We need to take into this account when calculating the gradients
w.r.t. mode frequencies.\\

Gradient of total displacement w.r.t. mode frequency,
\eqar{
  \pdiff{\alpha_k}{\delta_k}=&\sum_{n=0}^{N_s-1}\!\!\paren{
    \pdiff{\alpha_k^n}{\delta_k^n}
    +\ui T_n\alpha_k^n
  }
}

Gradient of total area w.r.t. mode frequency,
\eqar{
  \pdiff{\mathrm{Im}(\gamma_k)}{\delta_k}=&\sum_{n=0}^{N_s-1}\!\!\mathrm{Im}\paren{
    \paren{\pdiff{\alpha_k^n}{\delta_k^n}+\ui T_n\alpha_k^n}
    \sum_{n'=0}^{n-1}\!\!{\alpha_k^{n'}}^*
    +\paren{\pdiff{{\alpha_k^n}^*}{\delta_k^n}-\ui T_n{\alpha_k^n}^*}\sum_{n'=n+1}^{N_s-1}\!\!\!\!\alpha_k^{n'}
    +\pdiff{\gamma_k^n}{\delta_k^n}}
}

Now the gradients w.r.t. pulse parameter.
Let $x_n$ be a pulse parameter that is only directly affecting the $n$-th segment.
We have the expressions to compute the gradients of different quantities
w.r.t. this pulse parameter.\\

Total displacement
\eqar{
  \pdiff{\alpha_k}{x_n}=&\pdiff{\alpha_k^n}{x_n}
}

Total area,
\eqar{
  \pdiff{\mathrm{Im}(\gamma_k)}{x_n}=&
  \mathrm{Im}\paren{\pdiff{\alpha_k^n}{x_n}{A_k^n}^*
    +\pdiff{{\alpha_k^n}^*}{x_n}\sum_{n'=n+1}^{N_s-1}\!\!\!\!\alpha_k^{n'}
    +\pdiff{\gamma_k^n}{x_n}
  }
}

Cumulative displacement,
\eqar{
  \bar\alpha_k=&
  \pdiff{\tau_n}{x_n}A_k^n
  +\pdiff{\alpha_k^n}{x_n}\!\!\sum_{n'=n+1}^{N_s-1}\!\!\!\!\tau_{n'}
  +\pdiff{\bar\alpha_k^n}{x_n}
}

Gradient of total displacement w.r.t. mode frequency,
\eqar{
  \frac{\partial^2\alpha_k}{\partial\delta_k\partial x_n}=&
  \frac{\partial^2\alpha_k^n}{\partial\delta_k^n\partial x_n}
  +\ui T_n\pdiff{\alpha_k^n}{x_n}
  +\ui\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\!\!\alpha_k^{n'}\pdiff{\tau_n}{x_n}
}

Gradient of total area w.r.t. mode frequency,
\eqar{
  \frac{\partial^2\mathrm{Im}(\gamma_k)}{\partial\delta_k\partial x_n}=&
  \sum_{n'=0}^{N_s-1}\!\!\mathrm{Im}\lparen{
    \paren{
      \frac{\partial^2\alpha_k^{n'}}{\partial\delta_k^{n'}\partial x_n}
      +\ui \pdiff{T_{n'}}{x_n}\alpha_k^{n'}
      +\ui T_{n'}\pdiff{\alpha_k^{n'}}{x_n}}
    \sum_{n''=0}^{n'-1}\!\!{\alpha_k^{n''}}^*
    +\paren{
      \pdiff{\alpha_k^{n'}}{\delta_k^{n'}}+\ui T_{n'}\alpha_k^{n'}}
    \sum_{n''=0}^{n'-1}\!\!\pdiff{{\alpha_k^{n''}}^*}{x_n}
  }\\
  &
  +\paren{
    \frac{\partial^2{\alpha_k^{n'}}^*}{\partial\delta_k^{n'}\partial x_n}
    -\ui\pdiff{T_{n'}}{x_n}{\alpha_k^{n'}}^*
    -\ui T_{n'}\pdiff{{\alpha_k^{n'}}^*}{x_n}
  }\!\!\!\!\sum_{n''=n'+1}^{N_s-1}\!\!\!\!\alpha_k^{n''}
  \\
  &\rparen{
    +\paren{\pdiff{{\alpha_k^{n'}}^*}{\delta_k^{n'}}-\ui T_{n'}{\alpha_k^{n'}}^*}\!\!\!\!\sum_{n''=n+1}^{N_s-1}\!\!\!\!\pdiff{\alpha_k^{n''}}{x_n}
    +\frac{\partial^2\gamma_k^{n'}}{\partial\delta_k^{n'}\partial x_n}}\\
  =&
  \mathrm{Im}\lparen{
    \paren{
      \frac{\partial^2\alpha_k^{n}}{\partial\delta_k^{n}\partial x_n}
      +\ui T_{n}\pdiff{\alpha_k^{n}}{x_n}}
    \sum_{n'=0}^{n-1}\!\!{\alpha_k^{n'}}^*\!\!
    +\ui\pdiff{\tau_{n}}{x_n}\!\!\sum_{n'=n+1}^{N_s-1}\!\!\alpha_k^{n'}
    \!\!\sum_{n''=0}^{n'-1}\!\!{\alpha_k^{n''}}^*
  }\\
  &
  +\paren{
    \frac{\partial^2{\alpha_k^n}^*}{\partial\delta_k^n\partial x_n}
    -\ui T_n\pdiff{{\alpha_k^n}^*}{x_n}
  }\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\!\!\alpha_k^{n'}
  -\ui\pdiff{\tau_n}{x_n}\!\!\sum_{n'=n+1}^{N_s-1}\!\!{\alpha_k^{n'}}^*
  \!\!\!\!\sum_{n''=n'+1}^{N_s-1}\!\!\!\!\alpha_k^{n''}
  \\
  &\rparen{
    +\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\paren{
      \pdiff{\alpha_k^{n'}}{\delta_k^{n'}}+\ui T_{n'}\alpha_k^{n'}}
    \pdiff{{\alpha_k^{n}}^*}{x_n}
    +\sum_{n'=0}^{n-1}\!\!\paren{\pdiff{{\alpha_k^{n'}}^*}{\delta_k^{n'}}-\ui T_{n'}{\alpha_k^{n'}}^*}\pdiff{\alpha_k^{n}}{x_n}
    +\frac{\partial^2\gamma_k^n}{\partial\delta_k^n\partial x_n}}
}
The coefficient on $\ui\dfrac{\partial\tau_n}{\partial x_n}$
\eqar{
  &\sum_{n'=n+1}^{N_s-1}\!\!\alpha_k^{n'}\!\!\sum_{n''=0}^{n'-1}\!\!{\alpha_k^{n''}}^*
  -\sum_{n'=n+1}^{N_s-1}\!\!{\alpha_k^{n'}}^*\!\!\!\!\sum_{n''=n'+1}^{N_s-1}\!\!\!\!\alpha_k^{n''}\\
  =&\sum_{n'=n+1}^{N_s-1}\sum_{n''=0}^{n'-1}\!\!\alpha_k^{n'}{\alpha_k^{n''}}^*
  -\!\!\sum_{n''=n+1}^{N_s-1}\sum_{n'=n+1}^{n''-1}\!\!\!\!{\alpha_k^{n'}}^*\alpha_k^{n''}\\
  =&\sum_{n'=n+1}^{N_s-1}\paren{\sum_{n''=0}^{n'-1}\!\!\alpha_k^{n'}{\alpha_k^{n''}}^*
    -\!\!\sum_{n''=n+1}^{n'-1}\!\!\!\!\alpha_k^{n'}{\alpha_k^{n''}}^*}\\
  =&\paren{\sum_{n'=n+1}^{N_s-1}\!\!\alpha_k^{n'}}\paren{\sum_{n''=0}^{n}\!\!{\alpha_k^{n''}}^*}
}
\eqar{
  \frac{\partial^2\mathrm{Im}(\gamma_k)}{\partial\delta_k\partial x_n}=&
  \mathrm{Im}\lparen{
    \paren{
      \frac{\partial^2\alpha_k^{n}}{\partial\delta_k^{n}\partial x_n}
      +\ui T_{n}\pdiff{\alpha_k^{n}}{x_n}}
    \sum_{n'=0}^{n-1}\!\!{\alpha_k^{n'}}^*\!\!
    +\ui\pdiff{\tau_{n}}{x_n}\paren{\sum_{n'=n+1}^{N_s-1}\!\!\alpha_k^{n'}}\paren{\sum_{n''=0}^{n}\!\!{\alpha_k^{n''}}^*}
  }\\
  &
  +\paren{
    \frac{\partial^2{\alpha_k^n}^*}{\partial\delta_k^n\partial x_n}
    -\ui T_n\pdiff{{\alpha_k^n}^*}{x_n}
  }\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\!\!\alpha_k^{n'}
  \\
  &\rparen{
    +\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\paren{
      \pdiff{\alpha_k^{n'}}{\delta_k^{n'}}+\ui T_{n'}\alpha_k^{n'}}
    \pdiff{{\alpha_k^{n}}^*}{x_n}
    +\sum_{n'=0}^{n-1}\!\!\paren{\pdiff{{\alpha_k^{n'}}^*}{\delta_k^{n'}}-\ui T_{n'}{\alpha_k^{n'}}^*}\pdiff{\alpha_k^{n}}{x_n}
    +\frac{\partial^2\gamma_k^n}{\partial\delta_k^n\partial x_n}}\\
  =&
  \mathrm{Im}\lparen{
    \frac{\partial^2\alpha_k}{\partial\delta_k\partial x_n}
    \sum_{n'=0}^{n-1}\!\!{\alpha_k^{n'}}^*\!\!
    +\ui\pdiff{\tau_{n}}{x_n}{\alpha_k^n}^*\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\!\!\alpha_k^{n'}
    +\paren{
      \frac{\partial^2{\alpha_k^n}^*}{\partial\delta_k^n\partial x_n}
      -\ui T_n\pdiff{{\alpha_k^n}^*}{x_n}
    }
  }\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\!\!\alpha_k^{n'}
  \\
  &\rparen{
    +\!\!\!\!\sum_{n'=n+1}^{N_s-1}\!\!\paren{
      \pdiff{\alpha_k^{n'}}{\delta_k^{n'}}+\ui T_{n'}\alpha_k^{n'}}
    \pdiff{{\alpha_k^{n}}^*}{x_n}
    +\sum_{n'=0}^{n-1}\!\!\paren{\pdiff{{\alpha_k^{n'}}^*}{\delta_k^{n'}}-\ui T_{n'}{\alpha_k^{n'}}^*}\pdiff{\alpha_k^{n}}{x_n}
    +\frac{\partial^2\gamma_k^n}{\partial\delta_k^n\partial x_n}}
}

\end{document}
